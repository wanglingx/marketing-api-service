{"version":3,"file":"server.js","names":["g","require","url","compress","events","XMLHandler","Base","toXMLDate","util","debug","debugDetail","error","Server","constructor","server","path","services","wsdl","options","self","length","load","err","xmlHandler","definitions","schemas","listeners","slice","removeAllListeners","addListener","req","res","authorizeConnection","connection","remoteAddress","end","reqPath","parse","pathname","_requestListener","i","len","call","reqParse","reqQuery","search","log","method","toLowerCase","setHeader","write","toXML","headers","statusCode","chunks","gunzip","Gunzip","init","on","chunk","inflate","push","xml","join","result","_process","stack","input","callback","replace","obj","xmlToJson","body","Body","Header","bindings","binding","operation","operationName","serviceName","portName","includeTimestamp","Security","Timestamp","authenticate","Error","f","firstPort","name","service","ports","port","portPathname","location","style","Object","keys","emit","_executeMethod","outputName","args","messageElemName","pair","topElements","operations","inputParts","message","parts","firstInPart","element","$name","output","outPart","firstOutPart","Fault","undefined","_sendError","handled","_envelope","handleResult","operationDescriptor","describe","outputBodyDescriptor","soapNsURI","soapNsPrefix","envelopeKey","soapVersion","nsContext","createNamespaceContext","envelope","createSOAPEnvelope","jsonToXml","toString","pretty","doc","_addWSSecurityHeader","headerElement","secElement","attribute","now","Date","created","timeStampXml","expires","getTime","tsElement","env","header","soapHeaderElement","addSoapHeadersToEnvelope","fault","faultEnvDescriptor","descriptor","faultEnvelope","elements","bodyDescriptor","faultDescriptor","module","exports"],"sources":["../src/server.js"],"sourcesContent":["// Copyright IBM Corp. 2016,2018. All Rights Reserved.\n// Node module: strong-soap\n// This file is licensed under the MIT License.\n// License text available at https://opensource.org/licenses/MIT\n\n'use strict';\n\nvar g = require('./globalize');\nvar url = require('url'),\n  compress = null,\n  events = require('events'),\n  XMLHandler = require('./parser/xmlHandler'),\n  Base = require('./base'),\n  toXMLDate = require('./utils').toXMLDate,\n  util = require('util'),\n  debug = require('debug')('strong-soap:server'),\n  debugDetail = require('debug')('strong-soap:server:detail');\n\ntry {\n  compress = require('compress');\n} catch (error) {\n  // Ignore error\n}\n\nclass Server extends Base {\n\n  constructor(server, path, services, wsdl, options) {\n    super(wsdl, options);\n    var self = this;\n    options = options || {};\n    this.path = path;\n    this.services = services;\n\n    debug('Server parameters: path: %s services: %j wsdl: %j', path, services, wsdl);\n    if (path[path.length - 1] !== '/')\n      path += '/';\n    wsdl.load(function(err) {\n      if (err) throw err;\n      self.xmlHandler = new XMLHandler(self.wsdl.definitions.schemas, self.wsdl.options);\n      var listeners = server.listeners('request').slice();\n\n      server.removeAllListeners('request');\n      server.addListener('request', function(req, res) {\n        if (typeof self.authorizeConnection === 'function') {\n          if (!self.authorizeConnection(req.connection.remoteAddress)) {\n            res.end();\n            return;\n          }\n        }\n        var reqPath = url.parse(req.url).pathname;\n        if (reqPath[reqPath.length - 1] !== '/')\n          reqPath += '/';\n        if (path === reqPath) {\n          self._requestListener(req, res);\n        } else {\n          for (var i = 0, len = listeners.length; i < len; i++) {\n            listeners[i].call(this, req, res);\n          }\n        }\n      });\n    });\n  }\n\n  _requestListener(req, res) {\n    var self = this;\n    var reqParse = url.parse(req.url);\n    var reqPath = reqParse.pathname;\n    var reqQuery = reqParse.search;\n\n    if (typeof self.log === 'function') {\n      self.log('info', 'Handling ' + req.method + ' on ' + req.url);\n    }\n\n    if (req.method === 'GET') {\n      if (reqQuery && reqQuery.toLowerCase() === '?wsdl') {\n        if (typeof self.log === 'function') {\n          self.log('info', 'Wants the WSDL');\n        }\n        res.setHeader('Content-Type', 'application/xml');\n        res.write(self.wsdl.toXML());\n      }\n      res.end();\n    } else if (req.method === 'POST') {\n      if (!req.headers['content-type']) {\n        res.statusCode = 415;\n        res.write('The Content-Type is expected in the headers');\n        res.end();\n      } else {\n        res.setHeader('Content-Type', req.headers['content-type']);\n        var chunks = [], gunzip;\n        if (compress && req.headers['content-encoding'] === 'gzip') {\n          gunzip = new compress.Gunzip();\n          gunzip.init();\n        }\n        req.on('data', function(chunk) {\n          if (gunzip)\n            chunk = gunzip.inflate(chunk, 'binary');\n          chunks.push(chunk);\n        });\n        req.on('end', function() {\n          var xml = chunks.join('');\n          var result;\n          var error;\n          if (gunzip) {\n            gunzip.end();\n            gunzip = null;\n          }\n          try {\n            if (typeof self.log === 'function') {\n              self.log('received', xml);\n            }\n            self._process(xml, req, function(result, statusCode) {\n              if (statusCode) {\n                res.statusCode = statusCode;\n              }\n              res.write(result);\n              res.end();\n              if (typeof self.log === 'function') {\n                self.log('replied', result);\n              }\n            });\n          }\n          catch (err) {\n            error = err.stack || err;\n            res.statusCode = 500;\n            res.write(error);\n            res.end();\n            if (typeof self.log === 'function') {\n              self.log('error', error);\n            }\n          }\n        });\n      }\n    }\n    else {\n      res.end();\n    }\n  };\n\n  _process(input, req, callback) {\n    var self = this,\n      pathname = url.parse(req.url).pathname.replace(/\\/$/, ''),\n      obj = this.xmlHandler.xmlToJson(null, input),\n      body = obj.Body,\n      headers = obj.Header,\n      bindings = this.wsdl.definitions.bindings, binding,\n      operation, operationName,\n      serviceName, portName,\n      includeTimestamp = obj.Header && obj.Header.Security &&\n        obj.Header.Security.Timestamp;\n\n    if (typeof self.authenticate === 'function') {\n      if (!obj.Header || !obj.Header.Security) {\n        throw new Error(g.f('No security header'));\n      }\n      if (!self.authenticate(obj.Header.Security)) {\n        throw new Error(g.f('Invalid username or password'));\n      }\n    }\n\n    if (typeof self.log === 'function') {\n      self.log('info', 'Attempting to bind to ' + pathname);\n    }\n\n    // use port.location and current url to find the right binding\n    binding = (function(self) {\n      var services = self.wsdl.definitions.services;\n      var firstPort;\n      var name;\n      for (name in services) {\n        serviceName = name;\n        var service = services[serviceName];\n        var ports = service.ports;\n        for (name in ports) {\n          portName = name;\n          var port = ports[portName];\n          var portPathname = url.parse(port.location).pathname.replace(/\\/$/, '');\n\n          if (typeof self.log === 'function') {\n            self.log('info', 'Trying ' + portName + ' from path ' + portPathname);\n          }\n\n          if (portPathname === pathname)\n            return port.binding;\n\n          // The port path is almost always wrong for generated WSDLs\n          if (!firstPort) {\n            firstPort = port;\n          }\n        }\n      }\n      return !firstPort ? void 0 : firstPort.binding;\n    })(this);\n\n    if (!binding) {\n      throw new Error(g.f('Failed to bind to {{WSDL}}'));\n    }\n\n    try {\n      if (binding.style === 'rpc') {\n        operationName = Object.keys(body)[0];\n\n        self.emit('request', obj, operationName);\n        if (headers)\n          self.emit('headers', headers, operationName);\n\n        self._executeMethod({\n          serviceName: serviceName,\n          portName: portName,\n          operationName: operationName,\n          outputName: operationName + 'Response',\n          args: body[operationName],\n          headers: headers,\n          style: 'rpc'\n        }, req, callback);\n      } else { //document style\n        var messageElemName = (Object.keys(body)[0] === 'attributes' ?\n          Object.keys(body)[1] : Object.keys(body)[0]);\n        var pair = binding.topElements[messageElemName];\n\n        var operationName, outputName;\n        var operations = binding.operations;\n        //figure out the output name\n        for (var name in operations) {\n          var inputParts = operations[name].input.message.parts;\n          //find the first part of the input message. There could be more than one parts in input message.\n          var firstInPart = inputParts[Object.keys(inputParts)[0]];\n          if(firstInPart.element.$name === messageElemName) {\n            operationName = operations[name].$name;\n            if (operations[name].output != null) {\n              var outPart = operations[name].output.message.parts;\n              //there will be only one output part\n              var firstOutPart = outPart[Object.keys(outPart)[0]];\n              outputName = firstOutPart.element.$name;\n            }\n            break;\n          }\n        }\n\n        self.emit('request', obj, operationName);\n        if (headers)\n          self.emit('headers', headers, operationName);\n\n        self._executeMethod({\n          serviceName: serviceName,\n          portName: portName,\n          operationName: operationName,\n          outputName: outputName,\n          args: body[messageElemName],\n          headers: headers,\n          style: 'document',\n          includeTimestamp: includeTimestamp\n        }, req, callback);\n      }\n    } catch (error) {\n      if (error.Fault !== undefined) {\n        return self._sendError(operations[name], error, callback, includeTimestamp);\n      }\n      //Revisit - is this needed?\n      throw error;\n    }\n  };\n\n  _executeMethod(options, req, callback) {\n    options = options || {};\n    var self = this,\n      operation, body,\n      serviceName = options.serviceName,\n      portName = options.portName,\n      operationName = options.operationName,\n      outputName = options.outputName,\n      args = options.args,\n      style = options.style,\n      includeTimestamp = options.includeTimestamp,\n      handled = false;\n\n    try {\n      operation = this.services[serviceName][portName][operationName];\n      debug('Server operation: %s ', operationName);\n    } catch (error) {\n      debug('Server executeMethod: error: %s ', error.message);\n      //fix - should create a fault and call sendError (..) so that this error is not lost and will be sent as Fault in soap envelope\n      //to the client?\n      return callback(this._envelope('', includeTimestamp));\n    }\n\n    function handleResult(error, result) {\n      if (handled)\n        return;\n      handled = true;\n\n      var operation  = self.wsdl.definitions.services[serviceName]\n        .ports[portName].binding.operations[operationName];\n\n\n      if (error && error.Fault !== undefined) {\n        return self._sendError(operation, error, callback, includeTimestamp);\n      }\n      else if (result === undefined) {\n        // Backward compatibility to support one argument callback style\n        result = error;\n      }\n\n      var element = operation.output;\n\n      var operationDescriptor = operation.describe(self.wsdl.definitions);\n      debugDetail('Server handleResult. operationDescriptor: %j ', operationDescriptor);\n\n      var outputBodyDescriptor = operationDescriptor.output.body;\n      debugDetail('Server handleResult. outputBodyDescriptor: %j ', outputBodyDescriptor);\n\n      var soapNsURI = 'http://schemas.xmlsoap.org/soap/envelope/';\n      var soapNsPrefix = self.wsdl.options.envelopeKey || 'soap';\n\n      if (operation.soapVersion === '1.2') {\n        soapNsURI = 'http://www.w3.org/2003/05/soap-envelope';\n      }\n\n      debug('Server soapNsURI: %s soapNsPrefix: %s', soapNsURI, soapNsPrefix);\n\n      var nsContext = self.createNamespaceContext(soapNsPrefix, soapNsURI);\n      var envelope = XMLHandler.createSOAPEnvelope(soapNsPrefix, soapNsURI);\n\n\n      self.xmlHandler.jsonToXml(envelope.body, nsContext, outputBodyDescriptor, result);\n\n      self._envelope(envelope, includeTimestamp);\n      var message = envelope.body.toString({pretty: true});\n      var xml = envelope.doc.end({pretty: true});\n\n      debug('Server handleResult. xml: %s ', xml);\n      callback(xml);\n\n    }\n\n    if (!self.wsdl.definitions.services[serviceName].ports[portName]\n        .binding.operations[operationName].output) {\n      // no output defined = one-way operation so return empty response\n      handled = true;\n      callback('');\n    }\n\n    var result = operation(args, handleResult, options.headers, req);\n    if (typeof result !== 'undefined') {\n      handleResult(null, result);\n    }\n  };\n\n  _addWSSecurityHeader(headerElement) {\n    var secElement = headerElement.element('wsse:Security')\n      .attribute('soap:mustUnderstand', '1');\n\n    secElement\n      .attribute('xmlns:wsse', 'http://docs.oasis-open.org/wss/2004/01/' +\n        'oasis-200401-wss-wssecurity-secext-1.0.xsd')\n      .attribute('xmlns:wsu', 'http://docs.oasis-open.org/wss/2004/01/' +\n        'oasis-200401-wss-wssecurity-utility-1.0.xsd');\n\n    var now = new Date();\n    var created = toXMLDate(now);\n    var timeStampXml = '';\n\n    var expires = toXMLDate(new Date(now.getTime() + (1000 * 600)));\n\n    var tsElement = secElement.element('wsu:Timestamp')\n      .attribute('wsu:Id', 'Timestamp-' + created);\n    tsElement.element('wsu:Created', created);\n    tsElement.element('wsu:Expires', expires);\n\n  }\n\n  _envelope(env, includeTimestamp) {\n    env = env || XMLHandler.createSOAPEnvelope();\n\n    if (includeTimestamp) {\n      this._addWSSecurityHeader(env.header);\n    }\n\n    var soapHeaderElement = env.header;\n    //add soapHeaders to envelope. Header can be xml, or JSON object which may or may not be described in WSDL/XSD.\n    this.addSoapHeadersToEnvelope(soapHeaderElement, this.xmlHandler);\n    return env;\n  };\n\n  _sendError(operation, error, callback, includeTimestamp) {\n    var self = this,\n      fault;\n\n    var statusCode;\n    if (error.Fault.statusCode) {\n      statusCode = error.Fault.statusCode;\n      error.Fault.statusCode = undefined;\n    }\n\n    var operationDescriptor = operation.describe(this.wsdl.definitions);\n    debugDetail('Server sendError. operationDescriptor: %j ', operationDescriptor);\n\n    //get envelope descriptor\n    var faultEnvDescriptor = operation.descriptor.faultEnvelope.elements[0];\n\n\n    var soapNsURI = 'http://schemas.xmlsoap.org/soap/envelope/';\n    var soapNsPrefix = self.wsdl.options.envelopeKey || 'soap';\n\n    if (operation.soapVersion === '1.2') {\n      soapNsURI = 'http://www.w3.org/2003/05/soap-envelope';\n    }\n\n    var nsContext = self.createNamespaceContext(soapNsPrefix, soapNsURI);\n    var envelope = XMLHandler.createSOAPEnvelope(soapNsPrefix, soapNsURI);\n\n\n    //find the envelope body descriptor\n    var bodyDescriptor = faultEnvDescriptor.elements[1];\n\n    //there will be only one <Fault> element descriptor under <Body>\n    var faultDescriptor = bodyDescriptor.elements[0];\n    debugDetail('Server sendError. faultDescriptor: %j ', faultDescriptor);\n\n    debug('Server sendError.  error.Fault: %j ',  error.Fault);\n\n    //serialize Fault object into XML as per faultDescriptor\n    this.xmlHandler.jsonToXml(envelope.body, nsContext, faultDescriptor, error.Fault);\n\n    self._envelope(envelope, includeTimestamp);\n    var message = envelope.body.toString({pretty: true});\n    var xml = envelope.doc.end({pretty: true});\n\n    debug('Server sendError. Response envelope: %s ', xml);\n    callback(xml, statusCode);\n  }\n}\n\nmodule.exports = Server;\n"],"mappings":"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"}